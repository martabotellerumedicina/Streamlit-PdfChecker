import streamlit as st
import fitz
import re
import pandas as pd
from collections import Counter
from io import BytesIO

# -------------------------------------------------
# CONFIGURACI√ì STREAMLIT
# -------------------------------------------------

st.set_page_config(
        page_title="Comparador Models Moodle",
            layout="wide"
)

# -------------------------------------------------
# UTILITATS
# -------------------------------------------------

def normalitzar(text):
    """Normalitza text per assegurar coincid√®ncia exacta robusta."""
        return " ".join(text.strip().split()).lower()


        @st.cache_data(show_spinner=False)
        def extreure_preguntes(pdf_bytes):
            """
                Extreu preguntes que:
                    - Comencen amb '1)', '2)', etc.
                        - Finalitzen quan detecta text en cursiva
                            """
                                doc = fitz.open(stream=pdf_bytes, filetype="pdf")
                                    preguntes = []
                                        pregunta_actual = ""
                                            capturant = False

                                                for pagina in doc:
                                                        blocks = pagina.get_text("dict")["blocks"]

                                                                for block in blocks:
                                                                            if "lines" not in block:
                                                                                            continue

                                                                                                        for line in block["lines"]:
                                                                                                                        for span in line["spans"]:
                                                                                                                                            text = span["text"].strip()

                                                                                                                                                                # Inici pregunta
                                                                                                                                                                                    if re.match(r"^\d+\)", text):
                                                                                                                                                                                                            if pregunta_actual:
                                                                                                                                                                                                                                        preguntes.append(normalitzar(pregunta_actual))
                                                                                                                                                                                                                                                                pregunta_actual = text
                                                                                                                                                                                                                                                                                        capturant = True
                                                                                                                                                                                                                                                                                                                continue

                                                                                                                                                                                                                                                                                                                                    # Cursiva = final pregunta
                                                                                                                                                                                                                                                                                                                                                        if capturant and (span["flags"] & 2):
                                                                                                                                                                                                                                                                                                                                                                                preguntes.append(normalitzar(pregunta_actual))
                                                                                                                                                                                                                                                                                                                                                                                                        pregunta_actual = ""
                                                                                                                                                                                                                                                                                                                                                                                                                                capturant = False
                                                                                                                                                                                                                                                                                                                                                                                                                                                        continue

                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if capturant:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    pregunta_actual += " " + text

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if pregunta_actual:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                preguntes.append(normalitzar(pregunta_actual))

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    doc.close()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return preguntes


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def detectar_duplicades(preguntes):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            comptador = Counter(preguntes)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return [p for p, c in comptador.items() if c > 1]


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                def comparar_model_base(model_base_nom, preguntes_base, altres_models):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Comparaci√≥ O(n) utilitzant diccionaris.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            El text √©s id√®ntic entre models.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                """

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    index_models = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                nom: {pregunta: i + 1 for i, pregunta in enumerate(preguntes)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        for nom, preguntes in altres_models.items()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        files = []

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            for i, pregunta_base in enumerate(preguntes_base):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    fila = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "Base_Model": model_base_nom,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "Q_Base": i + 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            for nom_model, index in index_models.items():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        fila[nom_model] = index.get(pregunta_base, "")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                files.append(fila)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return pd.DataFrame(files)


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def generar_excel(df):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        output = BytesIO()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            with pd.ExcelWriter(output, engine="xlsxwriter") as writer:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    df.to_excel(writer, index=False, sheet_name="Correspondencia")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return output.getvalue()


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # -------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # INTERF√çCIE
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # -------------------------------------------------

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.title("üìò Comparador Professional de Models Moodle")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.markdown("""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Compara versions aleatoritzades del mateix examen exportat des de Moodle.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        El text ha de ser exactament igual (nom√©s canvia l'ordre).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        """)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # -------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # MODEL BASE
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # -------------------------------------------------

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.header("1Ô∏è‚É£ Model Base")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        model_base_file = st.file_uploader(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "Puja el PDF del model base",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    type="pdf",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        key="base"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # -------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # ALTRES MODELS
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # -------------------------------------------------

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.header("2Ô∏è‚É£ Altres Models")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        altres_files = st.file_uploader(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "Arrossega aqu√≠ la resta de models",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    type="pdf",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        accept_multiple_files=True,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            key="altres"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # -------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # EXECUCI√ì
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # -------------------------------------------------

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if st.button("üöÄ Comparar Models"):

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if not model_base_file:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.error("Has de pujar un model base.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.stop()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if not altres_files:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.error("Has de pujar almenys un model per comparar.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                st.stop()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    progress_bar = st.progress(0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        status_text = st.empty()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            total_steps = 1 + len(altres_files) + 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                current_step = 0

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # -------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # MODEL BASE
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # -------------------------

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                status_text.text("Processant model base...")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    base_name = model_base_file.name.replace(".pdf", "")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        preguntes_base = extreure_preguntes(model_base_file.read())
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            duplicades_base = detectar_duplicades(preguntes_base)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                current_step += 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    progress_bar.progress(current_step / total_steps)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if len(preguntes_base) == 0:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                st.error("No s'han detectat preguntes al model base.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.stop()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # -------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # ALTRES MODELS
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # -------------------------

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        altres_models = {}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            stats_models = {}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                for file in altres_files:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        status_text.text(f"Processant {file.name} ...")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                nom = file.name.replace(".pdf", "")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        preguntes = extreure_preguntes(file.read())

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                altres_models[nom] = preguntes
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        stats_models[nom] = len(preguntes)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                current_step += 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        progress_bar.progress(current_step / total_steps)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # -------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # COMPARACI√ì
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # -------------------------

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        status_text.text("Comparant models...")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            df = comparar_model_base(base_name, preguntes_base, altres_models)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                current_step += 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    progress_bar.progress(current_step / total_steps)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        status_text.text("‚úî Proc√©s completat")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # -------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # RESULTATS
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # -------------------------------------------------

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.success("Comparaci√≥ completada correctament ‚úÖ")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.subheader("üìä Preguntes detectades")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                st.info(f"Model base ({base_name}): {len(preguntes_base)} preguntes")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for nom, total in stats_models.items():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if total == len(preguntes_base):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.success(f"{nom}: {total} preguntes ‚úî")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.warning(f"{nom}: {total} preguntes ‚ö† (no coincideix amb el model base)")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if duplicades_base:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.warning(f"S'han detectat {len(duplicades_base)} preguntes duplicades al model base.")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.subheader("üìã Taula de correspond√®ncia")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                st.dataframe(df, use_container_width=True)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # -------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # EXPORTS
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # -------------------------------------------------

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                csv = df.to_csv(index=False).encode("utf-8")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    excel = generar_excel(df)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        colA, colB = st.columns(2)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            colA.download_button(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "‚¨á Descarregar CSV",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                csv,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "correspondencia_models.csv",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "text/csv"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            )

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                colB.download_button(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "‚¨á Descarregar Excel",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    excel,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "correspondencia_models.xlsx",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
)