import streamlit as st
import pdfplumber
import pandas as pd
import re
import io

st.set_page_config(page_title="PDF Exam Matcher", layout="wide")

st.title("Comparador de Models d'Examen (Moodle PDF)")

# -----------------------------
# FUNCIONS
# -----------------------------

def normalitzar(text):
    return " ".join(text.strip().split()).lower()

def extreure_preguntes(pdf_file):
    preguntes = {}
    with pdfplumber.open(pdf_file) as pdf:
        text_complet = ""
        for pagina in pdf.pages:
            text_complet += pagina.extract_text() + "\n"

    # Separaci√≥ per n√∫mero de pregunta (ex: 1. , 2. , 10.)
    blocs = re.split(r"\n\s*(\d+)\.\s", text_complet)

    # blocs[0] √©s text abans de la primera pregunta
    for i in range(1, len(blocs), 2):
        numero = blocs[i]
        contingut = blocs[i + 1]
        preguntes[numero] = normalitzar(contingut)

    return preguntes

def comparar_models(base, model):
    correspondencia = []
    for num_base, text_base in base.items():
        for num_model, text_model in model.items():
            if text_base == text_model:
                correspondencia.append({
                    "Pregunta_Model_Base": num_base,
                    "Pregunta_Model_Alt": num_model
                })
                break
    return correspondencia

# -----------------------------
# INTERF√çCIE
# -----------------------------

st.subheader("1Ô∏è‚É£ Pujar Model Base (Model A)")

model_base_file = st.file_uploader(
    "Puja el PDF del model base",
    type="pdf",
    key="base"
)

if model_base_file:
    base_preguntes = extreure_preguntes(model_base_file)
    st.success(f"Model base carregat. Preguntes trobades: {len(base_preguntes)}")

    st.subheader("2Ô∏è‚É£ Pujar Altres Models a Comparar")

    altres_models = st.file_uploader(
        "Puja un o m√©s PDFs",
        type="pdf",
        accept_multiple_files=True
    )

    if altres_models:

        progress = st.progress(0)
        resultats_totals = []

        for idx, model_file in enumerate(altres_models):

            model_preguntes = extreure_preguntes(model_file)

            st.info(f"{model_file.name} ‚Üí Preguntes trobades: {len(model_preguntes)}")

            correspondencia = comparar_models(base_preguntes, model_preguntes)

            for fila in correspondencia:
                fila["Model"] = model_file.name

            resultats_totals.extend(correspondencia)

            progress.progress((idx + 1) / len(altres_models))

        if resultats_totals:
            df = pd.DataFrame(resultats_totals)

            st.subheader("Resultats")
            st.dataframe(df)

            csv_buffer = io.StringIO()
            df.to_csv(csv_buffer, index=False)

            st.download_button(
                label="Descarregar CSV",
                data=csv_buffer.getvalue(),
                file_name="correspondencia_models.csv",
                mime="text/csv"
            )
        else:
            st.warning("No s'han trobat coincid√®ncies exactes.")
            continue

                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if capturant:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    pregunta_actual += " " + text

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if pregunta_actual:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                preguntes.append(normalitzar(pregunta_actual))

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    doc.close()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return preguntes


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def detectar_duplicades(preguntes):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            comptador = Counter(preguntes)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return [p for p, c in comptador.items() if c > 1]


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                def comparar_model_base(model_base_nom, preguntes_base, altres_models):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Comparaci√≥ O(n) utilitzant diccionaris.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            El text √©s id√®ntic entre models.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                """

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    index_models = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                nom: {pregunta: i + 1 for i, pregunta in enumerate(preguntes)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        for nom, preguntes in altres_models.items()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        files = []

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            for i, pregunta_base in enumerate(preguntes_base):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    fila = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "Base_Model": model_base_nom,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "Q_Base": i + 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            for nom_model, index in index_models.items():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        fila[nom_model] = index.get(pregunta_base, "")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                files.append(fila)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return pd.DataFrame(files)


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def generar_excel(df):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        output = BytesIO()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            with pd.ExcelWriter(output, engine="xlsxwriter") as writer:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    df.to_excel(writer, index=False, sheet_name="Correspondencia")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return output.getvalue()


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # -------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # INTERF√çCIE
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # -------------------------------------------------

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.title("üìò Comparador Professional de Models Moodle")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.markdown("""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Compara versions aleatoritzades del mateix examen exportat des de Moodle.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        El text ha de ser exactament igual (nom√©s canvia l'ordre).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        """)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # -------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # MODEL BASE
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # -------------------------------------------------

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.header("1Ô∏è‚É£ Model Base")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        model_base_file = st.file_uploader(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "Puja el PDF del model base",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    type="pdf",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        key="base"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # -------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # ALTRES MODELS
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # -------------------------------------------------

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.header("2Ô∏è‚É£ Altres Models")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        altres_files = st.file_uploader(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "Arrossega aqu√≠ la resta de models",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    type="pdf",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        accept_multiple_files=True,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            key="altres"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # -------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # EXECUCI√ì
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # -------------------------------------------------

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if st.button("üöÄ Comparar Models"):

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if not model_base_file:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.error("Has de pujar un model base.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.stop()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if not altres_files:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.error("Has de pujar almenys un model per comparar.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                st.stop()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    progress_bar = st.progress(0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        status_text = st.empty()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            total_steps = 1 + len(altres_files) + 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                current_step = 0

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # -------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # MODEL BASE
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # -------------------------

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                status_text.text("Processant model base...")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    base_name = model_base_file.name.replace(".pdf", "")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        preguntes_base = extreure_preguntes(model_base_file.read())
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            duplicades_base = detectar_duplicades(preguntes_base)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                current_step += 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    progress_bar.progress(current_step / total_steps)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if len(preguntes_base) == 0:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                st.error("No s'han detectat preguntes al model base.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.stop()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # -------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # ALTRES MODELS
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # -------------------------

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        altres_models = {}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            stats_models = {}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                for file in altres_files:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        status_text.text(f"Processant {file.name} ...")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                nom = file.name.replace(".pdf", "")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        preguntes = extreure_preguntes(file.read())

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                altres_models[nom] = preguntes
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        stats_models[nom] = len(preguntes)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                current_step += 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        progress_bar.progress(current_step / total_steps)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # -------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # COMPARACI√ì
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # -------------------------

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        status_text.text("Comparant models...")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            df = comparar_model_base(base_name, preguntes_base, altres_models)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                current_step += 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    progress_bar.progress(current_step / total_steps)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        status_text.text("‚úî Proc√©s completat")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # -------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # RESULTATS
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # -------------------------------------------------

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.success("Comparaci√≥ completada correctament ‚úÖ")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.subheader("üìä Preguntes detectades")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                st.info(f"Model base ({base_name}): {len(preguntes_base)} preguntes")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for nom, total in stats_models.items():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if total == len(preguntes_base):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.success(f"{nom}: {total} preguntes ‚úî")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.warning(f"{nom}: {total} preguntes ‚ö† (no coincideix amb el model base)")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if duplicades_base:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.warning(f"S'han detectat {len(duplicades_base)} preguntes duplicades al model base.")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.subheader("üìã Taula de correspond√®ncia")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                st.dataframe(df, use_container_width=True)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # -------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # EXPORTS
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # -------------------------------------------------

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                csv = df.to_csv(index=False).encode("utf-8")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    excel = generar_excel(df)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        colA, colB = st.columns(2)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            colA.download_button(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "‚¨á Descarregar CSV",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                csv,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "correspondencia_models.csv",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "text/csv"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            )

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                colB.download_button(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "‚¨á Descarregar Excel",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    excel,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "correspondencia_models.xlsx",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
)
